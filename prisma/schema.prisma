// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Brand {
  id       String       @id @default(cuid())
  name     String       @unique
  products LensProduct[]
}

model PhotochromicTech {
  id                String        @id @default(cuid())
  name              String        @unique
  descriptionFr     String
  descriptionEn     String
  descriptionAr     String?
  descriptionDarija String?
  lenses            LensProduct[]
}

model Coating {
  id           String        @id @default(cuid())
  code         String        @unique
  labelFr      String
  labelEn      String
  labelAr      String?
  labelDarija  String?
  lensCoatings LensCoating[]
}

model LensProduct {
  id                String            @id @default(cuid())
  sku               String            @unique

  brandId           String
  brand             Brand             @relation(fields: [brandId], references: [id])
  family            String?
  index             Float
  material          String?
  isAspheric        Boolean           @default(false)

  // Prescription ranges (optional, but useful for validation and recommendation).
  minSph            Float?
  maxSph            Float?
  minCyl            Float?
  maxCyl            Float?

  // Capabilities / options.
  photochromic      Boolean           @default(false)
  photochromicTechId String?
  photochromicTech  PhotochromicTech? @relation(fields: [photochromicTechId], references: [id])
  blueCut           Boolean           @default(false)

  description       String?

  coatings          LensCoating[]
  inventory         InventoryItem[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([brandId])
  @@index([index])
  @@index([photochromic])
  @@index([blueCut])
}

model LensCoating {
  lensId    String
  coatingId String

  lens      LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)
  coating   Coating     @relation(fields: [coatingId], references: [id], onDelete: Cascade)

  @@id([lensId, coatingId])
}

model InventoryItem {
  id        String      @id @default(cuid())
  lensId    String
  lens      LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)

  // Your business data.
  supplier  String?
  priceCents Int
  currency  String      @default("DZD")
  quantity  Int         @default(0)
  isActive  Boolean     @default(true)

  updatedAt DateTime    @updatedAt

  @@index([lensId])
  @@index([isActive])
}

model ChatSession {
  id           String        @id @default(cuid())
  title        String
  systemPrompt String?
  summary      String?
  language     String?

  messages     ChatMessage[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([updatedAt])
}

model ChatMessage {
  id        String      @id @default(cuid())
  chatId    String
  chat      ChatSession @relation(fields: [chatId], references: [id], onDelete: Cascade)

  role      String
  content   String

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([chatId])
  @@index([createdAt])
}

model ChatMemory {
  id        String   @id @default(cuid())

  // No auth in this app yet, so we store memory in scopes:
  // - "global" for cross-chat memory
  // - "chat:<chatId>" for chat-specific memory
  scope     String   @default("global")
  key       String
  value     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scope, key])
  @@index([scope])
}
